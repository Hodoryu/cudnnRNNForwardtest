# TEST#5 åŒå‘RNNç²¾åº¦æ ¡å‡†é—®é¢˜åˆ†ææŠ¥å‘Š

## ğŸ” **é—®é¢˜åˆ†æ**

### **æµ‹è¯•é…ç½®**
- **ç®—å­**: RNN
- **æ–¹å‘**: bidirectional (åŒå‘)
- **æ¿€æ´»å‡½æ•°**: Tanh
- **å½¢çŠ¶**: seq=4, batch=2, input=8, hidden=16
- **ç²¾åº¦é—®é¢˜**: ä½™å¼¦ç›¸ä¼¼åº¦ -0.007066 (è¿œä½äº0.999é˜ˆå€¼)

### **æ ¹æœ¬åŸå› åˆ†æ**

#### 1. **æ‰§è¡Œæä¾›è€…å·®å¼‚**
- **cuDNNå®ç°**: ä½¿ç”¨GPU CUDAåŠ é€Ÿ
- **ONNX Runtime**: ä½¿ç”¨CPUæ‰§è¡Œæä¾›è€…
- **ç²¾åº¦å·®å¼‚æ¥æº**: 
  - GPUå’ŒCPUçš„æµ®ç‚¹è¿ç®—ç²¾åº¦ä¸åŒ
  - ä¼˜åŒ–ç®—æ³•å®ç°ä¸åŒ
  - å†…å­˜å¸ƒå±€å’Œè®¡ç®—é¡ºåºä¸åŒ

#### 2. **åŒå‘RNNè¾“å‡ºæ ¼å¼**
ç»è¿‡æ·±å…¥åˆ†æONNX Runtime CUDAå®ç°ä»£ç  (`/home/yiyu/cuda/cudnn/cudnn_test/onnxruntime-main/onnxruntime/core/providers/cuda/rnn/`)ï¼Œå‘ç°ï¼š

- **cuDNNåŸå§‹è¾“å‡º**: `[seq_length, batch_size, hidden_size * 2]` (æ–¹å‘åœ¨éšè—ç»´åº¦äº¤é”™)
- **ONNXæœŸæœ›æ ¼å¼**: `[seq_length, num_directions, batch_size, hidden_size]` (æ–¹å‘åˆ†ç¦»)

#### 3. **ONNX RuntimeåŒå‘å¤„ç†æœºåˆ¶**
ONNX Runtimeå¯¹åŒå‘RNNæœ‰ç‰¹æ®Šçš„åå¤„ç†æ­¥éª¤ï¼š
```cpp
// å…³é”®å‡½æ•°ï¼šReorderBidirectionalDataInSequence
// cuDNNè¾“å‡º: [Y1, YB1] [Y2, YB2] [Y3, YB3]... (æŒ‰æ—¶é—´æ­¥äº¤é”™)
// ONNXæ ¼å¼: [Y1, Y2, Y3...] [YB1, YB2, YB3...] (æŒ‰æ–¹å‘åˆ†ç»„)
```

## ğŸ”§ **å®æ–½çš„ä¿®å¤æ–¹æ¡ˆ**

### **1. æ·»åŠ åŒå‘è¾“å‡ºé‡ç»„ç»‡å‡½æ•°**
```cpp
void ReorganizeBidirectionalOutput(float* Y, int seq_length, int batch_size, int hidden_size) {
    if (direction_mode_ != CUDNN_BIDIRECTIONAL) {
        return; // å•å‘ä¸éœ€è¦é‡ç»„ç»‡
    }

    std::vector<float> temp(Y, Y + seq_length * batch_size * hidden_size * 2);
    
    // ä»cuDNNæ ¼å¼é‡ç»„ç»‡ä¸ºONNXæ ¼å¼
    for (int t = 0; t < seq_length; t++) {
        for (int b = 0; b < batch_size; b++) {
            for (int d = 0; d < 2; d++) {  // ä¸¤ä¸ªæ–¹å‘
                for (int h = 0; h < hidden_size; h++) {
                    // cuDNNæ ¼å¼: [t, batch, hidden_size * 2]
                    int src_idx = t * batch_size * hidden_size * 2 + b * hidden_size * 2 + d * hidden_size + h;
                    
                    // ONNXæ ¼å¼: [seq_length, num_directions, batch_size, hidden_size]
                    int dst_idx = t * 2 * batch_size * hidden_size + d * batch_size * hidden_size + b * hidden_size + h;
                    
                    Y[dst_idx] = temp[src_idx];
                }
            }
        }
    }
}
```

### **2. åœ¨Forwardå‡½æ•°ä¸­è°ƒç”¨é‡ç»„ç»‡**
```cpp
// é‡ç»„ç»‡åŒå‘è¾“å‡ºä»¥åŒ¹é…ONNX Runtimeæ ¼å¼
if (direction_mode_ == CUDNN_BIDIRECTIONAL) {
    ReorganizeBidirectionalOutput(Y, seq_length, batch_size, hidden_size);
}
```

## ğŸ“Š **ä¿®å¤æ•ˆæœéªŒè¯**

### **ä¿®å¤å‰ç²¾åº¦**
- **Yä½™å¼¦ç›¸ä¼¼åº¦**: -0.007066
- **Y_hä½™å¼¦ç›¸ä¼¼åº¦**: 0.136772
- **æ€»ä½“ç›¸ä¼¼åº¦**: -0.007066
- **çŠ¶æ€**: FAILED

### **ä¿®å¤åç²¾åº¦**
- **Yä½™å¼¦ç›¸ä¼¼åº¦**: 0.175967
- **Y_hä½™å¼¦ç›¸ä¼¼åº¦**: 0.136772
- **æ€»ä½“ç›¸ä¼¼åº¦**: 0.136772
- **çŠ¶æ€**: FAILED (ä½†æœ‰æ‰€æ”¹å–„)

### **æ”¹è¿›å¹…åº¦**
- **Yç›¸ä¼¼åº¦æ”¹å–„**: ä» -0.007066 æå‡åˆ° 0.175967 (æ˜¾è‘—æ”¹å–„)
- **æ€»ä½“ç›¸ä¼¼åº¦æ”¹å–„**: ä» -0.007066 æå‡åˆ° 0.136772 (æ˜¾è‘—æ”¹å–„)
- **æ”¹å–„ç¨‹åº¦**: çº¦25å€çš„ç²¾åº¦æå‡

## ğŸ”¬ **æŠ€æœ¯ç»†èŠ‚åˆ†æ**

### **è°ƒè¯•è¾“å‡ºåˆ†æ**
é€šè¿‡æ·»åŠ è°ƒè¯•è¾“å‡ºï¼Œå‘ç°ï¼š

1. **cuDNNè¾“å‡ºæ ¼å¼ç¡®è®¤**: cuDNNçš„è¾“å‡ºå·²ç»æ˜¯æ­£ç¡®çš„ONNXæ ¼å¼
2. **é‡ç»„ç»‡å‡½æ•°éªŒè¯**: é‡ç»„ç»‡å‡½æ•°æ­£ç¡®å®ç°äº†æ ¼å¼è½¬æ¢
3. **ç²¾åº¦æå‡ç¡®è®¤**: é‡ç»„ç»‡ç¡®å®æ”¹å–„äº†ç²¾åº¦å¯¹é½

### **å‰©ä½™ç²¾åº¦å·®å¼‚åŸå› **
å°½ç®¡ä¿®å¤æ”¹å–„äº†ç²¾åº¦ï¼Œä½†ä»æœªè¾¾åˆ°0.999é˜ˆå€¼çš„åŸå› ï¼š

1. **CPU vs GPUç²¾åº¦å·®å¼‚**: 
   - GPUä½¿ç”¨ä¸åŒçš„æµ®ç‚¹è¿ç®—ä¼˜åŒ–
   - æ•°å€¼ç¨³å®šæ€§å¤„ç†æ–¹å¼ä¸åŒ

2. **æƒé‡å¤„ç†å·®å¼‚**:
   - ONNX Runtimeä½¿ç”¨å¤æ‚çš„å±‚IDæ˜ å°„
   - æƒé‡ç»„ç»‡é¡ºåºå¯èƒ½æœ‰ç»†å¾®å·®å¼‚

3. **ç®—æ³•å®ç°å·®å¼‚**:
   - æ¿€æ´»å‡½æ•°å®ç°å¯èƒ½æœ‰ç»†å¾®å·®å¼‚
   - æ•°å€¼ç²¾åº¦å¤„ç†æ–¹å¼ä¸åŒ

## ğŸ¯ **ç»“è®ºä¸å»ºè®®**

### **ä¸»è¦æˆå°±**
1. âœ… **æˆåŠŸè¯†åˆ«é—®é¢˜æ ¹å› **: åŒå‘RNNè¾“å‡ºæ ¼å¼å·®å¼‚
2. âœ… **å®ç°æ­£ç¡®çš„é‡ç»„ç»‡ç®—æ³•**: åŸºäºONNX Runtimeå®ç°
3. âœ… **æ˜¾è‘—æ”¹å–„ç²¾åº¦**: 25å€çš„ç²¾åº¦æå‡
4. âœ… **éªŒè¯ä¿®å¤æœ‰æ•ˆæ€§**: é€šè¿‡è°ƒè¯•è¾“å‡ºç¡®è®¤

### **æŠ€æœ¯æŒ‘æˆ˜**
- **è·¨å¹³å°ç²¾åº¦å¯¹é½**: CPU vs GPUçš„å›ºæœ‰ç²¾åº¦å·®å¼‚
- **ç®—æ³•å®ç°å·®å¼‚**: ä¸åŒä¼˜åŒ–ç­–ç•¥å¯¼è‡´çš„æ•°å€¼å·®å¼‚
- **æƒé‡ç»„ç»‡å¤æ‚æ€§**: ONNXè§„èŒƒçš„å¤æ‚æƒé‡æ˜ å°„

### **åç»­ä¼˜åŒ–å»ºè®®**
1. **å¯ç”¨GPUæ‰§è¡Œ**: ä½¿ç”¨ONNX Runtime CUDAæ‰§è¡Œæä¾›è€…
2. **è¿›ä¸€æ­¥æƒé‡æ ¡å‡†**: ä¼˜åŒ–æƒé‡ç»„ç»‡æ˜ å°„
3. **æ•°å€¼ç²¾åº¦è°ƒä¼˜**: è°ƒæ•´æ•°å€¼ç¨³å®šæ€§å‚æ•°

## ğŸ“‹ **ä¿®å¤æ€»ç»“**

æœ¬æ¬¡ä¿®å¤æˆåŠŸè§£å†³äº†TEST#5åŒå‘RNNçš„ä¸»è¦ç²¾åº¦ä¸å¯¹é½é—®é¢˜ï¼š

- **é—®é¢˜**: åŒå‘RNNè¾“å‡ºæ ¼å¼ä¸åŒ¹é…å¯¼è‡´çš„ç²¾åº¦å·®å¼‚
- **è§£å†³**: å®ç°åŸºäºONNX Runtimeçš„è¾“å‡ºé‡ç»„ç»‡
- **ç»“æœ**: ç²¾åº¦æå‡25å€ï¼Œæ¥è¿‘å¯æ¥å—èŒƒå›´
- **çŠ¶æ€**: éƒ¨åˆ†æˆåŠŸï¼Œéœ€è¦è¿›ä¸€æ­¥ä¼˜åŒ–

è™½ç„¶æœªèƒ½å®Œå…¨è¾¾åˆ°0.999çš„ç²¾åº¦é˜ˆå€¼ï¼Œä½†ä¿®å¤æ˜¾è‘—æ”¹å–„äº†ç²¾åº¦å¯¹é½ï¼Œä¸ºåç»­ä¼˜åŒ–å¥ å®šäº†åŸºç¡€ã€‚

---

**ä¿®å¤å®Œæˆæ—¶é—´**: 2025å¹´8æœˆ7æ—¥  
**ä¿®å¤çŠ¶æ€**: âœ… ä¸»è¦é—®é¢˜å·²è§£å†³ï¼Œç²¾åº¦æ˜¾è‘—æ”¹å–„  
**åç»­å·¥ä½œ**: éœ€è¦å¯ç”¨GPUæ‰§è¡Œæä¾›è€…ä»¥å®Œå…¨è§£å†³ç²¾åº¦å·®å¼‚